<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LunchSpot – 점심 맛집 아카이브 (JSON fetch)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif; margin: 0; background:#f7f7f8; }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    header { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; justify-content:space-between; margin-bottom:12px; }
    h1 { font-size: 20px; margin: 0; }
    .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input[type='text'], select { padding:8px 10px; border-radius:10px; border:1px solid #ddd; background:#fff; }
    input[type='range'] { width: 200px; }
    .pill { padding: 6px 10px; border:1px solid #ddd; border-radius:999px; background:#fff; font-size:12px; cursor:pointer; }
    .pill.on { background:#111; color:#fff; }
    .grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; }
    @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
    .card { background:#fff; border:1px solid #e7e7ea; border-radius:16px; padding:14px; }
    .muted { color:#666; font-size:12px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px; }
    .tag { background:#f0f0f3; color:#444; padding:2px 6px; border-radius:999px; font-size:10px; margin-right:4px; display:inline-block; }
    .seg { display:inline-flex; border: 1px solid #ddd; border-radius: 12px; overflow: hidden; background:#fff; }
    .seg button { padding:6px 10px; border:0; background:transparent; cursor:pointer; }
    .seg button.on { background:#111; color:#fff; }
    footer { text-align:center; margin:18px 0 8px; color:#777; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>🍱 LunchSpot – 점심 맛집 아카이브</h1>
        <div class="muted">데이터는 <code>lunch_data.json</code>에서 fetch로 불러옵니다.</div>
      </div>
      <div class="controls">
        <div class="seg">
          <button id="tab-rest" class="on">식당</button>
          <button id="tab-cafe">카페</button>
        </div>
        <select id="sort">
          <option value="score">정렬: 점수</option>
          <option value="distance">정렬: 거리</option>
          <option value="wait">정렬: 대기</option>
          <option value="price">정렬: 가격</option>
        </select>
        <input id="q" type="text" placeholder="검색: 이름/음식/태그" />
      </div>
    </header>

    <section class="controls" style="margin-bottom:12px;">
      <div>최대 거리: <span id="dOut">1.2</span>km<br/><input id="d" type="range" min="0.2" max="2" step="0.1" value="1.2"/></div>
      <div>최대 가격: ₩<span id="pOut">15000</span><br/><input id="p" type="range" min="4000" max="20000" step="500" value="15000"/></div>
      <div>최대 대기: <span id="wOut">20</span>분<br/><input id="w" type="range" min="0" max="40" step="1" value="20"/></div>
    </section>

    <div class="muted" id="count"></div>
    <div class="grid" id="grid"></div>

    <footer>점수 = 0.35·맛 + 0.25·속도 + 0.2·가성비 + 0.1·건강 + 0.1·쾌적 (1–5)</footer>
  </div>

  <script>
    let RESTAURANTS = [], CAFES = [];
    const $ = (sel)=>document.querySelector(sel);
    const q=$('#q'), sort=$('#sort'), d=$('#d'), p=$('#p'), w=$('#w'), dOut=$('#dOut'), pOut=$('#pOut'), wOut=$('#wOut'), grid=$('#grid'), count=$('#count'), tabRest=$('#tab-rest'), tabCafe=$('#tab-cafe');
    let dataset='restaurants';

    function normTags(v){ if(!v) return []; if(Array.isArray(v)) return v; return String(v).split(',').map(s=>s.trim()).filter(Boolean); }
    function isFiniteNumber(n){ return typeof n==='number' && isFinite(n); }
    function computeWalk(r){ if(isFiniteNumber(r.walking_time_min)) return r.walking_time_min; if(isFiniteNumber(r.distance_km)) return Math.round(r.distance_km*1000/80); }
    function clamp01(n){ return Math.max(0,Math.min(1,n)); }
    function score5(r){ const t=clamp01((r.taste_rating_1_5||0)/5), s=clamp01((r.speed_rating_1_5||0)/5), v=clamp01((r.value_rating_1_5||0)/5), h=clamp01((r.health_rating_1_5||0)/5), c=clamp01((r.comfort_rating_1_5||0)/5); return +((0.35*t+0.25*s+0.2*v+0.1*h+0.1*c)*5).toFixed(2); }
    function normalize(list){ return list.map(r=>({ ...r, tags:normTags(r.tags), walking_time_min:computeWalk(r), lunch_score:isFiniteNumber(r.lunch_score)?r.lunch_score:score5(r) })); }
    function dataNow(){ return normalize(dataset==='cafes'? CAFES : RESTAURANTS); }

    function render(){
      dOut.textContent=(+d.value).toFixed(1); pOut.textContent=p.value; wOut.textContent=w.value;
      const data=dataNow().filter(r=>{
        const km=isFiniteNumber(r.distance_km)?r.distance_km:999;
        const pp=isFiniteNumber(r.price_min_krw)?r.price_min_krw:0;
        const wt=isFiniteNumber(r.lunch_peak_wait_min)?r.lunch_peak_wait_min:0;
        const ql=q.value.trim().toLowerCase();
        const hay=[r.name,r.cuisine,r.area,r.signature_dish,r.address,(r.tags||[]).join(' ')].join(' ').toLowerCase();
        return km<=+d.value && pp<=+p.value && wt<=+w.value && (ql?hay.includes(ql):true);
      }).sort((a,b)=> sort.value==='score' ? (b.lunch_score||0)-(a.lunch_score||0) : sort.value==='distance' ? (a.distance_km||99)-(b.distance_km||99) : sort.value==='wait' ? (a.lunch_peak_wait_min||0)-(b.lunch_peak_wait_min||0) : (a.price_min_krw||0)-(b.price_min_krw||0) );
      count.textContent=`${data.length} 곳`;
      grid.innerHTML=data.map(r=>`<div class="card"><div style="display:flex;justify-content:space-between;gap:8px;"><div><div style="font-weight:700;">${r.name??'—'}</div><div class="muted">${r.cuisine??'—'} · ${r.area??''}</div></div><div style="text-align:right;"><div style="font-size:18px;font-weight:700;">${isFiniteNumber(r.lunch_score)?r.lunch_score.toFixed(1):'—'}</div><div class="muted">lunch score</div></div></div>
      <div class="row"><div>💸 가격: ₩${(r.price_min_krw??'—').toLocaleString?.('ko-KR')||r.price_min_krw??'—'}–₩${(r.price_max_krw??'—').toLocaleString?.('ko-KR')||r.price_max_krw??'—'}</div><div>🚶 거리: ${(r.distance_km??'—')} km (${r.walking_time_min??'—'}분)</div><div>⏱️ 대기(피크): ${r.lunch_peak_wait_min??'—'}분</div><div>🥗 시그니처: ${r.signature_dish??'—'}</div></div>
      <div style="margin-top:6px;">${(r.tags||[]).map(t=>`<span class="tag">${t}</span>`).join(' ')}</div>
      <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;">${r.latitude&&r.longitude?`<a class="pill" href="https://www.google.com/maps/search/?api=1&query=${r.latitude},${r.longitude}" target="_blank">Google Maps</a>`:''}
        <a class="pill" href="https://map.naver.com/v5/search/${encodeURIComponent(r.name||'')}" target="_blank">Naver Map</a>${r.website?`<a class="pill" href="${r.website}" target="_blank">Website</a>`:''}</div></div>`).join('');
    }

    [q,sort,d,p,w].forEach(el=>el.addEventListener('input',render));
    tabRest.addEventListener('click',()=>{dataset='restaurants';tabRest.classList.add('on');tabCafe.classList.remove('on');render();});
    tabCafe.addEventListener('click',()=>{dataset='cafes';tabCafe.classList.add('on');tabRest.classList.remove('on');render();});

    fetch('lunch_data.json')
      .then(r=>r.json())
      .then(data=>{ RESTAURANTS=data.restaurants||[]; CAFES=data.cafes||[]; render(); })
      .catch(err=>{ count.textContent='데이터 로드 실패: ' + err; });
  </script>
</body>
</html>
